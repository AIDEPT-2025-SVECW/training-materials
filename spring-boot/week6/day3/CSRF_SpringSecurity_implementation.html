<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding CSRF and Spring Security Protection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .section {
            background: white;
            margin: 20px 0;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s ease;
        }

        .section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .section h2 {
            color: #4a5568;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.8rem;
        }

        .section h3 {
            color: #2d3748;
            margin: 20px 0 15px 0;
            font-size: 1.3rem;
        }

        pre {
            background: #1a202c;
            color: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #e53e3e;
        }

        .demo-box {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
        }

        .navigation {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 1000;
        }

        .nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-dot.active {
            background: white;
            transform: scale(1.3);
        }

        .csrf-token-display {
            background: #38a169;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }

        .attack-simulation {
            background: #fed7d7;
            border: 2px solid #e53e3e;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .protection-example {
            background: #c6f6d5;
            border: 2px solid #38a169;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1001;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="progress-bar">
        <div class="progress" id="progressBar"></div>
    </div>

    <div class="navigation" id="navigation">
        <div class="nav-dot active" data-section="0"></div>
        <div class="nav-dot" data-section="1"></div>
        <div class="nav-dot" data-section="2"></div>
        <div class="nav-dot" data-section="3"></div>
        <div class="nav-dot" data-section="4"></div>
        <div class="nav-dot" data-section="5"></div>
        <div class="nav-dot" data-section="6"></div>

    </div>

    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è CSRF Security Tutorial</h1>
            <p>Understanding Cross-Site Request Forgery and Spring Security Protection</p>
        </div>

        <div class="section visible" id="section-0">
            <h2>What is CSRF (Cross-Site Request Forgery)?</h2>
            <p>CSRF is a type of malicious exploit where unauthorized commands are transmitted from a user that the web application trusts. It tricks a user's browser into executing unwanted actions on a web application in which they're currently authenticated.</p>
            
            <div class="highlight">
                <strong>Key Point:</strong> CSRF attacks exploit the trust that a web application has in a user's browser, not the trust the user has in the web application.
            </div>

            <h3>How CSRF Attacks Work:</h3>
            <ol>
                <li>User logs into a legitimate website (like their bank)</li>
                <li>Website creates a session and stores authentication cookies</li>
                <li>User visits a malicious website while still logged in</li>
                <li>Malicious site sends requests to the legitimate site using the user's credentials</li>
                <li>Legitimate site processes these requests as if they came from the user</li>
            </ol>

            <button class="btn" onclick="showCSRFExample()">See CSRF Attack Example</button>
        </div>

        <div class="section" id="section-1">
            <h2>CSRF Attack Simulation</h2>
            <div class="attack-simulation">
                <h3>üö® Malicious Website Example</h3>
                <p>Imagine you're logged into your bank account. A malicious website could contain this hidden form:</p>
                
                <pre id="maliciousForm">
&lt;!-- This form is hidden on a malicious website --&gt;
&lt;form id="maliciousTransfer" action="https://yourbank.com/transfer" method="POST" style="display:none;"&gt;
    &lt;input type="hidden" name="to" value="attacker@evil.com" /&gt;
    &lt;input type="hidden" name="amount" value="1000" /&gt;
&lt;/form&gt;

&lt;script&gt;
    // Auto-submit when page loads
    document.getElementById('maliciousTransfer').submit();
&lt;/script&gt;</pre>

                <p><strong>Problem:</strong> Your browser automatically includes your authentication cookies with this request, making the bank think YOU initiated the transfer!</p>
                
                <button class="btn btn-danger" onclick="simulateAttack()">Simulate Attack (Safe Demo)</button>
                <div id="attackResult"></div>
            </div>
        </div>

        <div class="section" id="section-2">
            <h2>Why CSRF Tokens Are Needed</h2>
            <p>CSRF tokens solve the fundamental problem: <strong>How can a server distinguish between legitimate requests from the user and forged requests from malicious sites?</strong></p>

            <div class="demo-box">
                <h3>CSRF Token Properties:</h3>
                <ul>
                    <li><strong>Unpredictable:</strong> Cryptographically random values that attackers cannot guess</li>
                    <li><strong>Unique:</strong> Different for each session or request</li>
                    <li><strong>Secret:</strong> Only known to the legitimate website and user</li>
                    <li><strong>Validated:</strong> Server checks the token on every state-changing request</li>
                </ul>
            </div>

            <h3>Generate a Sample CSRF Token:</h3>
            <button class="btn" onclick="generateCSRFToken()">Generate New Token</button>
            <div id="tokenDisplay"></div>
        </div>

        <div class="section" id="section-3">
            <h2>Spring Security CSRF Protection</h2>
            <p>Spring Security provides built-in CSRF protection that's enabled by default. Here's how it works:</p>

            <h3>1. Enable CSRF Protection (Default)</h3>
            <code>
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
                .ignoringRequestMatchers("/api/public/**") // Exclude specific endpoints
            )
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/login", "/register").permitAll()
                .anyRequest().authenticated()
            );
        return http.build();
    }
}</code>

            <h3>2. HTML Form Integration</h3>
            <pre>
&lt;!-- Spring automatically includes CSRF token in forms --&gt;
&lt;form th:action="@{/transfer}" method="post"&gt;
    &lt;!-- This hidden input is automatically added by Thymeleaf --&gt;
    &lt;input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/&gt;
    
    &lt;input type="text" name="recipient" placeholder="Recipient"/&gt;
    &lt;input type="number" name="amount" placeholder="Amount"/&gt;
    &lt;button type="submit"&gt;Transfer Money&lt;/button&gt;
&lt;/form&gt;</pre>

            <h3>3. AJAX Integration</h3>
            <code>
                
// Include CSRF token in AJAX requests
var token = $("meta[name='_csrf']").attr("content");
var header = $("meta[name='_csrf_header']").attr("content");

$.ajaxSetup({
    beforeSend: function(xhr) {
        xhr.setRequestHeader(header, token);
    }
});

// Or include in request body
$.post("/transfer", {
    recipient: "john@example.com",
    amount: 100,
    _token: token
});</code>
        </div>

        <div class="section" id="section-4">
            <h2>Interactive Demo: Protected Form</h2>
            <div class="protection-example">
                <h3>‚úÖ CSRF Protected Form</h3>
                <p>This form demonstrates how Spring Security protects against CSRF attacks:</p>
                
                <form id="protectedForm" onsubmit="handleProtectedSubmit(event)">
                    <div style="margin: 10px 0;">
                        <label>Recipient:</label>
                        <input type="text" name="recipient" placeholder="Enter recipient email" style="margin-left: 10px; padding: 5px;">
                    </div>
                    <div style="margin: 10px 0;">
                        <label>Amount:</label>
                        <input type="number" name="amount" placeholder="Enter amount" style="margin-left: 10px; padding: 5px;">
                    </div>
                    <div style="margin: 10px 0;">
                        <label>CSRF Token:</label>
                        <input type="text" id="csrfTokenInput" readonly style="margin-left: 10px; padding: 5px; background: #f0f0f0;" placeholder="Token will appear here">
                    </div>
                    <button type="submit" class="btn">Submit Transfer (Protected)</button>
                </form>
                
                <div id="formResult"></div>
            </div>

            <h3>Try Without CSRF Token:</h3>
            <button class="btn btn-danger" onclick="simulateUnprotectedRequest()">Simulate Request Without Token</button>
            <div id="unprotectedResult"></div>
        </div>

        <div class="section" id="section-5">
            <h2>Best Practices & Advanced Configuration</h2>
            
            <h3>1. Custom CSRF Token Repository</h3>
            <pre>
@Bean
public CsrfTokenRepository csrfTokenRepository() {
    HttpSessionCsrfTokenRepository repository = new HttpSessionCsrfTokenRepository();
    repository.setHeaderName("X-XSRF-TOKEN");
    repository.setParameterName("_csrf");
    return repository;
}</pre>

            <h3>2. Conditional CSRF Protection</h3>
            <pre>
http.csrf(csrf -> csrf
    .requireCsrfProtectionMatcher(request -> 
        // Only protect state-changing operations
        !request.getMethod().equals("GET") && 
        !request.getMethod().equals("HEAD") &&
        !request.getMethod().equals("OPTIONS")
    )
);</pre>

            <h3>3. Custom CSRF Failure Handler</h3>
            <pre>
@Component
public class CustomCsrfFailureHandler implements AccessDeniedHandler {
    
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, 
                      AccessDeniedException exception) throws IOException {
        
        if (exception instanceof CsrfException) {
            response.setStatus(HttpStatus.FORBIDDEN.value());
            response.getWriter().write("CSRF token validation failed");
        }
    }
}</pre>

            <div class="highlight">
                <h3>üîí Security Checklist:</h3>
                <ul>
                    <li>‚úÖ Enable CSRF protection for all state-changing operations</li>
                    <li>‚úÖ Use HTTPS to prevent token interception</li>
                    <li>‚úÖ Implement proper token validation on the server</li>
                    <li>‚úÖ Use secure, random token generation</li>
                    <li>‚úÖ Set appropriate token expiration times</li>
                    <li>‚úÖ Handle CSRF failures gracefully</li>
                </ul>
            </div>

            <button class="btn" onclick="showSummary()">Show Security Summary</button>
            <div id="summaryResult"></div>
        </div>

        <div class="section" id="section-6">
    <h2>‚ö†Ô∏è Simulated CSRF Attack (HTML Form with Method Override)</h2>
    <p>This form simulates a CSRF attack that submits a POST request with a hidden `_method=DELETE` to delete a student record.</p>
    
    <div class="highlight"><h3>üõ†Ô∏è Step Before Simulating CSRF</h3><p>Before clicking 'Simulate CSRF Attack', configure your Spring Boot SecurityConfig like this:</p><pre>
// Step 1: Import Customizer.withDefaults
import static org.springframework.security.config.Customizer.withDefaults;

// Step 2: Define SecurityFilterChain bean
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .csrf(csrf -&gt; csrf
            .ignoringRequestMatchers("/students/**") // Disable CSRF for student endpoints
        )
        .authorizeHttpRequests(auth -&gt; auth
            .anyRequest().authenticated()
        )
        .formLogin(withDefaults())     // Enable default form login
        .httpBasic(withDefaults());    // Enable HTTP Basic authentication

    return http.build();
}

// Step 3: Enable HiddenHttpMethodFilter if using _method override for DELETE
@Bean
public HiddenHttpMethodFilter hiddenHttpMethodFilter() {
    return new HiddenHttpMethodFilter();
}
</pre></div>

    <form action="http://localhost:8080/students/20B013453" method="POST" id="deleteStudentForm" style="display:none;" target="_blank">
        <input type="hidden" name="_method" value="DELETE" />
        <input type="submit" value="Submit Delete" />
    </form>

    <button class="btn btn-danger" onclick="document.getElementById('deleteStudentForm').submit()">Book your free movie tickets</button>

    <div class="highlight" style="margin-top: 20px;">
        <strong>Important:</strong> This form relies on your server-side framework interpreting `_method=DELETE` in POST requests.
        In Spring, you must enable the <code>HiddenHttpMethodFilter</code>.
    </div>
        </div>


    </div>

    <script>
        // Tutorial state management
        let currentSection = 0;
        const sections = document.querySelectorAll('.section');
        const navDots = document.querySelectorAll('.nav-dot');
        
        // Intersection Observer for section visibility
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    const sectionIndex = Array.from(sections).indexOf(entry.target);
                    updateNavigation(sectionIndex);
                    updateProgress(sectionIndex);
                }
            });
        }, { threshold: 0.5 });

        sections.forEach(section => observer.observe(section));

        // Navigation functionality
        navDots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                sections[index].scrollIntoView({ behavior: 'smooth' });
            });
        });

        function updateNavigation(activeIndex) {
            navDots.forEach((dot, index) => {
                dot.classList.toggle('active', index === activeIndex);
            });
            currentSection = activeIndex;
        }

        function updateProgress(sectionIndex) {
            const progress = ((sectionIndex + 1) / sections.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // CSRF token generation
        function generateCSRFToken() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let token = '';
            for (let i = 0; i < 32; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            const tokenDisplay = document.getElementById('tokenDisplay');
            tokenDisplay.innerHTML = `
                <div class="csrf-token-display pulse">
                    <strong>Generated CSRF Token:</strong><br>
                    ${token}
                </div>
                <p><em>This token would be unique for each user session and validated on every request.</em></p>
            `;
            
            // Update the form token input
            const csrfInput = document.getElementById('csrfTokenInput');
            if (csrfInput) {
                csrfInput.value = token;
            }
        }

        // CSRF attack simulation
        function showCSRFExample() {
            const maliciousForm = document.getElementById('maliciousForm');
            maliciousForm.classList.add('pulse');
            setTimeout(() => maliciousForm.classList.remove('pulse'), 2000);
        }

        function simulateAttack() {
            const resultDiv = document.getElementById('attackResult');
            resultDiv.innerHTML = `
                <div style="background: #fed7d7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <h4>üö® Attack Simulation Result:</h4>
                    <p><strong>Without CSRF Protection:</strong> ‚ùå Attack would succeed!</p>
                    <p>The malicious request would be processed because:</p>
                    <ul>
                        <li>Browser automatically includes authentication cookies</li>
                        <li>Server cannot distinguish between legitimate and forged requests</li>
                        <li>No additional verification mechanism in place</li>
                    </ul>
                </div>
            `;
        }

        // Protected form handling
        function handleProtectedSubmit(event) {
            event.preventDefault();
            const token = document.getElementById('csrfTokenInput').value;
            const recipient = event.target.recipient.value;
            const amount = event.target.amount.value;
            
            const resultDiv = document.getElementById('formResult');
            
            if (!token) {
                resultDiv.innerHTML = `
                    <div style="background: #fed7d7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h4>‚ùå Request Rejected</h4>
                        <p>CSRF token is missing. Please generate a token first.</p>
                    </div>
                `;
                return;
            }
            
            if (!recipient || !amount) {
                resultDiv.innerHTML = `
                    <div style="background: #fef5e7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h4>‚ö†Ô∏è Validation Error</h4>
                        <p>Please fill in all required fields.</p>
                    </div>
                `;
                return;
            }
            
            resultDiv.innerHTML = `
                <div style="background: #c6f6d5; padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <h4>‚úÖ Request Accepted</h4>
                    <p><strong>Transfer Details:</strong></p>
                    <ul>
                        <li>Recipient: ${recipient}</li>
                        <li>Amount: $${amount}</li>
                        <li>CSRF Token: ${token.substring(0, 8)}...</li>
                        <li>Status: Validated and processed securely</li>
                    </ul>
                </div>
            `;
        }

        function simulateUnprotectedRequest() {
            const resultDiv = document.getElementById('unprotectedResult');
            resultDiv.innerHTML = `
                <div style="background: #fed7d7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <h4>üö® Spring Security Response:</h4>
                    <pre style="background: #1a202c; color: #f56565; padding: 10px; border-radius: 5px;">
HTTP/1.1 403 Forbidden
Content-Type: application/json

{
  "timestamp": "2024-01-15T10:30:00.000+00:00",
  "status": 403,
  "error": "Forbidden",
  "message": "Expected CSRF token not found. Has your session expired?",
  "path": "/transfer"
}</pre>
                    <p><strong>Protection Working:</strong> ‚úÖ Request blocked due to missing CSRF token!</p>
                </div>
            `;
        }

        function showSummary() {
            const resultDiv = document.getElementById('summaryResult');
            resultDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <h3>üõ°Ô∏è CSRF Protection Summary</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h4>Without CSRF Protection:</h4>
                            <ul style="margin-top: 10px;">
                                <li>‚ùå Vulnerable to forged requests</li>
                                <li>‚ùå No request verification</li>
                                <li>‚ùå Session hijacking possible</li>
                                <li>‚ùå Data integrity at risk</li>
                            </ul>
                        </div>
                        <div>
                            <h4>With Spring Security CSRF:</h4>
                            <ul style="margin-top: 10px;">
                                <li>‚úÖ Cryptographic token validation</li>
                                <li>‚úÖ Request origin verification</li>
                                <li>‚úÖ Session security enhanced</li>
                                <li>‚úÖ Data integrity protected</li>
                            </ul>
                        </div>
                    </div>
                    <p style="margin-top: 15px; font-style: italic;">
                        Spring Security's CSRF protection is your first line of defense against cross-site request forgery attacks!
                    </p>
                </div>
            `;
        }

        // Initialize with a CSRF token
        window.addEventListener('load', () => {
            setTimeout(generateCSRFToken, 1000);
        });

        // Smooth scrolling for better UX
        document.documentElement.style.scrollBehavior = 'smooth';
    </script>
</body>
</html>