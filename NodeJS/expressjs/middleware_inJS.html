<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding Middleware in JavaScript</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #764ba2;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .analogy-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .analogy-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .explanation {
            line-height: 1.8;
            color: #333;
            margin-bottom: 15px;
        }
        
        .demo-area {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .middleware-chain {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .middleware-box {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            min-width: 150px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .middleware-box.active {
            transform: scale(1.1);
            background: #ffd700;
            color: #333;
            box-shadow: 0 5px 15px rgba(255,215,0,0.5);
        }
        
        .arrow {
            font-size: 2em;
            color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-request { color: #4ec9b0; }
        .log-middleware { color: #dcdcaa; }
        .log-response { color: #ce9178; }
        .log-error { color: #f48771; }
        
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .key-point {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Understanding Middleware in JavaScript</h1>
        <p class="subtitle">An interactive guide to mastering the middleware pattern</p>
        
        <div class="section">
            <h2>üìö What is Middleware?</h2>
            <p class="explanation">
                <strong>Middleware</strong> is a design pattern where functions are chained together to process requests sequentially. 
                Each middleware function can:
            </p>
            <ul style="margin-left: 30px; line-height: 2;">
                <li>Execute code before the main handler</li>
                <li>Modify the request or response</li>
                <li>End the request-response cycle</li>
                <li>Call the next middleware in the chain</li>
            </ul>
            
            <div class="analogy-box">
                <h3>üè≠ Real-World Analogy: Assembly Line</h3>
                <p class="explanation">
                    Think of middleware like an <strong>assembly line in a factory</strong>:
                </p>
                <ul style="margin-left: 30px; line-height: 1.8;">
                    <li><strong>Raw Material</strong> ‚Üí The incoming request</li>
                    <li><strong>Assembly Stations</strong> ‚Üí Each middleware function</li>
                    <li><strong>Workers at Each Station</strong> ‚Üí Can inspect, modify, or reject the item</li>
                    <li><strong>Passing to Next Station</strong> ‚Üí Calling next()</li>
                    <li><strong>Final Product</strong> ‚Üí The response sent back</li>
                </ul>
                <p class="explanation" style="margin-top: 10px;">
                    If any station finds a defect, it can stop the process (error handling). 
                    Otherwise, it improves the product and passes it along!
                </p>
            </div>
        </div>
        
        <div class="section">
            <h2>üéØ Interactive Demo: Middleware Chain</h2>
            <div class="demo-area">
                <p class="explanation"><strong>Watch how a request flows through middleware:</strong></p>
                
                <div class="middleware-chain">
                    <div class="middleware-box" id="m1">Logger</div>
                    <span class="arrow">‚Üí</span>
                    <div class="middleware-box" id="m2">Auth</div>
                    <span class="arrow">‚Üí</span>
                    <div class="middleware-box" id="m3">Validator</div>
                    <span class="arrow">‚Üí</span>
                    <div class="middleware-box" id="m4">Handler</div>
                </div>
                
                <div class="input-group">
                    <label>Enter your name (for validation):</label>
                    <input type="text" id="userName" placeholder="e.g., John Doe">
                </div>
                
                <div style="text-align: center;">
                    <button onclick="runMiddleware()">üöÄ Send Request</button>
                    <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
                </div>
                
                <div class="log-area" id="logArea"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>üíª Code Example: Building Middleware</h2>
            <p class="explanation">Here's how to implement a simple middleware system from scratch:</p>
            
            <pre>// Middleware System Implementation
class MiddlewareSystem {
    constructor() {
        this.middlewares = [];
    }
    
    // Add middleware to the chain
    use(fn) {
        this.middlewares.push(fn);
        return this; // Enable chaining
    }
    
    // Execute all middleware in sequence
    async execute(context) {
        let index = 0;
        
        const next = async () => {
            if (index >= this.middlewares.length) return;
            
            const middleware = this.middlewares[index++];
            await middleware(context, next);
        };
        
        await next();
        return context;
    }
}

// Example Usage
const app = new MiddlewareSystem();

// Middleware 1: Logger
app.use(async (ctx, next) => {
    console.log(`[${new Date().toISOString()}] ${ctx.method} ${ctx.path}`);
    await next(); // Pass to next middleware
});

// Middleware 2: Authentication
app.use(async (ctx, next) => {
    if (!ctx.user) {
        ctx.status = 401;
        ctx.body = 'Unauthorized';
        return; // Stop here if not authenticated
    }
    await next();
});

// Middleware 3: Main Handler
app.use(async (ctx, next) => {
    ctx.body = `Hello, ${ctx.user}!`;
    await next();
});

// Execute the chain
const context = {
    method: 'GET',
    path: '/hello',
    user: 'Alice'
};

app.execute(context);</pre>
            
            <div class="key-point">
                <strong>üîë Key Points:</strong>
                <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                    <li>Each middleware receives <code>context</code> (shared data) and <code>next</code> (function to call next middleware)</li>
                    <li>Calling <code>next()</code> passes control to the next middleware</li>
                    <li>NOT calling <code>next()</code> stops the chain (useful for errors or early responses)</li>
                    <li>Middleware can run code both BEFORE and AFTER calling <code>next()</code></li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>üåä The "Onion Model"</h2>
            <div class="analogy-box">
                <h3>üßÖ Understanding Request/Response Flow</h3>
                <p class="explanation">
                    Middleware follows an "onion model" - the request goes through layers going IN, 
                    and the response goes through the same layers coming OUT:
                </p>
                <pre>Request  ‚Üí  [MW1 ‚Üí  [MW2 ‚Üí  [MW3 ‚Üí  Handler]  ‚Üê MW3]  ‚Üê MW2]  ‚Üê MW1  ‚Üí  Response

Example execution:
1. MW1: Before next()
2.   MW2: Before next()
3.     MW3: Before next()
4.       Handler: Process request
5.     MW3: After next()
6.   MW2: After next()
7. MW1: After next()</pre>
            </div>
            
            <pre>// Demonstrating the Onion Model
app.use(async (ctx, next) => {
    console.log('‚Üí MW1: Before');
    await next();
    console.log('‚Üê MW1: After');
});

app.use(async (ctx, next) => {
    console.log('  ‚Üí MW2: Before');
    await next();
    console.log('  ‚Üê MW2: After');
});

app.use(async (ctx, next) => {
    console.log('    ‚Üí Handler: Processing');
});

// Output:
// ‚Üí MW1: Before
//   ‚Üí MW2: Before
//     ‚Üí Handler: Processing
//   ‚Üê MW2: After
// ‚Üê MW1: After</pre>
        </div>
        
        <div class="section">
            <h2>üõ†Ô∏è Common Middleware Use Cases</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="analogy-box">
                    <h3>üîê Authentication</h3>
                    <p>Verify user identity before processing requests</p>
                    <pre>app.use(async (ctx, next) => {
    const token = ctx.headers.token;
    if (!isValid(token)) {
        ctx.status = 401;
        return;
    }
    ctx.user = decode(token);
    await next();
});</pre>
                </div>
                
                <div class="analogy-box">
                    <h3>üìù Logging</h3>
                    <p>Track requests and responses for debugging</p>
                    <pre>app.use(async (ctx, next) => {
    const start = Date.now();
    await next();
    const ms = Date.now() - start;
    console.log(
        `${ctx.method} ${ctx.url} - ${ms}ms`
    );
});</pre>
                </div>
                
                <div class="analogy-box">
                    <h3>‚úÖ Validation</h3>
                    <p>Check request data before processing</p>
                    <pre>app.use(async (ctx, next) => {
    if (!ctx.body.email) {
        ctx.status = 400;
        ctx.body = 'Email required';
        return;
    }
    await next();
});</pre>
                </div>
                
                <div class="analogy-box">
                    <h3>‚ùå Error Handling</h3>
                    <p>Catch and handle errors gracefully</p>
                    <pre>app.use(async (ctx, next) => {
    try {
        await next();
    } catch (err) {
        ctx.status = 500;
        ctx.body = 'Server Error';
        console.error(err);
    }
});</pre>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>üéì Summary</h2>
            <div class="key-point">
                <strong>Middleware is powerful because it:</strong>
                <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                    <li>‚ú® <strong>Separates concerns</strong> - Each middleware handles one responsibility</li>
                    <li>üîÑ <strong>Enables reusability</strong> - Use the same middleware across different routes</li>
                    <li>üì¶ <strong>Promotes modularity</strong> - Easy to add, remove, or reorder middleware</li>
                    <li>üß™ <strong>Simplifies testing</strong> - Test each middleware function independently</li>
                    <li>üéØ <strong>Improves maintainability</strong> - Clear flow and single responsibility</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        let logEntries = [];
        
        function log(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            logEntries.push({ message, type, timestamp });
            updateLog();
        }
        
        function updateLog() {
            const logArea = document.getElementById('logArea');
            logArea.innerHTML = logEntries.map(entry => 
                `<div class="log-entry log-${entry.type}">[${entry.timestamp}] ${entry.message}</div>`
            ).join('');
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            logEntries = [];
            updateLog();
            document.querySelectorAll('.middleware-box').forEach(box => {
                box.classList.remove('active');
            });
        }
        
        async function activateMiddleware(id, duration = 1000) {
            const box = document.getElementById(id);
            box.classList.add('active');
            await new Promise(resolve => setTimeout(resolve, duration));
            box.classList.remove('active');
        }
        
        async function runMiddleware() {
            clearLog();
            const userName = document.getElementById('userName').value.trim();
            
            log('üöÄ Request initiated', 'request');
            
            // Middleware 1: Logger
            await activateMiddleware('m1', 800);
            log('üìù Logger Middleware: Logging request details', 'middleware');
            log(`   Method: GET, Path: /api/greet, Time: ${new Date().toISOString()}`, 'middleware');
            
            // Middleware 2: Auth
            await activateMiddleware('m2', 800);
            log('üîê Auth Middleware: Checking authentication', 'middleware');
            log('   ‚úÖ User authenticated successfully', 'middleware');
            
            // Middleware 3: Validator
            await activateMiddleware('m3', 800);
            log('‚úÖ Validator Middleware: Validating input', 'middleware');
            
            if (!userName) {
                log('   ‚ùå Validation failed: Name is required', 'error');
                log('üõë Request stopped - sending error response', 'error');
                return;
            }
            
            if (userName.length < 2) {
                log('   ‚ùå Validation failed: Name must be at least 2 characters', 'error');
                log('üõë Request stopped - sending error response', 'error');
                return;
            }
            
            log(`   ‚úÖ Validation passed for: ${userName}`, 'middleware');
            
            // Middleware 4: Handler
            await activateMiddleware('m4', 800);
            log('üéØ Handler: Processing request', 'middleware');
            log(`   Creating response for ${userName}`, 'middleware');
            
            // Response flowing back
            log('', 'response');
            log('‚¨ÖÔ∏è Response flowing back through middleware chain', 'response');
            log('   Handler ‚Üí Validator ‚Üí Auth ‚Üí Logger', 'response');
            log(`üì§ Response sent: { status: 200, message: "Hello, ${userName}!" }`, 'response');
            log('‚ú® Request completed successfully', 'response');
        }
    </script>
</body>
</html>